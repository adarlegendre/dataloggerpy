{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- System Status Cards -->
        <div class="col-12 mb-4">
            <div class="row">
                <!-- Disk Usage Card -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-hdd me-2"></i>Disk Usage
                            </h5>
                            {% if system_info.disk %}
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar disk-progress {% if system_info.disk.percent > 90 %}bg-danger{% elif system_info.disk.percent > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ system_info.disk.percent }}%"
                                     aria-valuenow="{{ system_info.disk.percent }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ system_info.disk.percent }}%
                                </div>
                            </div>
                            {% if system_info.history.disk_avg %}
                            <div class="text-center text-muted small disk-avg">
                                <i class="fas fa-chart-line me-1"></i>24h Avg: {{ system_info.history.disk_avg }}%
                            </div>
                            {% endif %}
                            <div class="row text-center">
                                <div class="col">
                                    <small class="text-muted">Total</small>
                                    <p class="mb-0 disk-total">{{ system_info.disk.total }} GB</p>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Used</small>
                                    <p class="mb-0 disk-used">{{ system_info.disk.used }} GB</p>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Free</small>
                                    <p class="mb-0 disk-free">{{ system_info.disk.free }} GB</p>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-danger">Unable to get disk information</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- RAM Usage Card -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-memory me-2"></i>RAM Usage
                            </h5>
                            {% if system_info.ram %}
                            <div class="progress mb-3" style="height: 20px;">
                                <div class="progress-bar ram-progress {% if system_info.ram.percent > 90 %}bg-danger{% elif system_info.ram.percent > 70 %}bg-warning{% else %}bg-success{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ system_info.ram.percent }}%"
                                     aria-valuenow="{{ system_info.ram.percent }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ system_info.ram.percent }}%
                                </div>
                            </div>
                            {% if system_info.history.ram_avg %}
                            <div class="text-center text-muted small ram-avg">
                                <i class="fas fa-chart-line me-1"></i>24h Avg: {{ system_info.history.ram_avg }}%
                            </div>
                            {% endif %}
                            <div class="row text-center">
                                <div class="col">
                                    <small class="text-muted">Total</small>
                                    <p class="mb-0 ram-total">{{ system_info.ram.total }} GB</p>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Used</small>
                                    <p class="mb-0 ram-used">{{ system_info.ram.used }} GB</p>
                                </div>
                                <div class="col">
                                    <small class="text-muted">Free</small>
                                    <p class="mb-0 ram-free">{{ system_info.ram.free }} GB</p>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-danger">Unable to get RAM information</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- CPU Temperature Card -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-thermometer-half me-2"></i>CPU Temperature
                            </h5>
                            {% if system_info.cpu_temp is not None %}
                            <div class="text-center">
                                <h2 class="display-4 cpu-temp {% if system_info.cpu_temp > 80 %}text-danger{% elif system_info.cpu_temp > 70 %}text-warning{% else %}text-success{% endif %}">
                                    {{ system_info.cpu_temp }}°C
                                </h2>
                                {% if system_info.history.cpu_avg %}
                                <div class="text-muted small cpu-avg">
                                    <i class="fas fa-chart-line me-1"></i>24h Avg: {{ system_info.history.cpu_avg }}°C
                                </div>
                                {% endif %}
                            </div>
                            {% else %}
                            <p class="text-danger">Unable to get CPU temperature</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- System Uptime Card -->
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-clock me-2"></i>System Uptime
                            </h5>
                            <div class="text-center">
                                <h2 class="display-6 uptime">{{ system_info.uptime }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Radar Configurations and Data Files -->
        <div class="col-12">
            {% for radar in radars %}
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-radar me-2"></i>{{ radar.name }}
                            <span class="badge {% if radar.is_active %}bg-success{% else %}bg-danger{% endif %} ms-2">
                                {% if radar.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </h5>
                        <small class="text-muted">Port: {{ radar.port }}</small>
                    </div>

                    <!-- Error Message Display -->
                    <div id="error_{{ radar.id }}" class="alert alert-danger mb-3" style="display: none;"></div>

                    <!-- Radar Graphs -->
                    <div class="row mb-4">
                        <!-- Time Range Control -->
                        <div class="col-12 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-clock me-2"></i>Time Range
                                        </h6>
                                        <div class="d-flex align-items-center">
                                            <div class="btn-group btn-group-sm me-3">
                                                <button class="btn btn-outline-secondary" onclick="setTimeRange({{ radar.id }}, 0.083)">5s</button>
                                                <button class="btn btn-outline-secondary" onclick="setTimeRange({{ radar.id }}, 1)">1m</button>
                                                <button class="btn btn-outline-secondary" onclick="setTimeRange({{ radar.id }}, 5)">5m</button>
                                                <button class="btn btn-outline-secondary" onclick="setTimeRange({{ radar.id }}, 10)">10m</button>
                                                <button class="btn btn-outline-secondary" onclick="setTimeRange({{ radar.id }}, 30)">30m</button>
                                            </div>
                                            <div class="input-group input-group-sm" style="width: 250px;">
                                                <input type="number" class="form-control" id="customTimeRange_{{ radar.id }}" 
                                                       min="0.083" max="60" value="5" step="0.083"
                                                       onchange="setCustomTimeRange({{ radar.id }}, this.value)">
                                                <select class="form-select" style="width: 100px;" 
                                                        onchange="updateTimeRangeUnit({{ radar.id }}, this.value)">
                                                    <option value="minutes">minutes</option>
                                                    <option value="seconds">seconds</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">Range</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary" onclick="resetRangeLimits({{ radar.id }})">
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                        </div>
                                    </div>
                                    <div class="range-controls mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">Min: <span class="range-min-value">-100</span></small>
                                            <small class="text-muted">Max: <span class="range-max-value">100</span></small>
                                        </div>
                                        <div class="range-sliders">
                                            <input type="range" class="form-range range-min" 
                                                   min="-200" max="200" value="-100" step="1"
                                                   oninput="updateRangeLimits({{ radar.id }})">
                                            <input type="range" class="form-range range-max" 
                                                   min="-200" max="200" value="100" step="1"
                                                   oninput="updateRangeLimits({{ radar.id }})">
                                        </div>
                                    </div>
                                    <div style="width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 4px;">
                                        <canvas id="rangeChart_{{ radar.id }}" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">Speed</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary" onclick="resetSpeedLimits({{ radar.id }})">
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                        </div>
                                    </div>
                                    <div class="range-controls mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">Min: <span class="speed-min-value">0</span></small>
                                            <small class="text-muted">Max: <span class="speed-max-value">1000</span></small>
                                        </div>
                                        <div class="range-sliders">
                                            <input type="range" class="form-range speed-min" 
                                                   min="0" max="2000" value="0" step="10"
                                                   oninput="updateSpeedLimits({{ radar.id }})">
                                            <input type="range" class="form-range speed-max" 
                                                   min="0" max="2000" value="1000" step="10"
                                                   oninput="updateSpeedLimits({{ radar.id }})">
                                        </div>
                                    </div>
                                    <div style="width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 4px;">
                                        <canvas id="speedChart_{{ radar.id }}" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title mb-0">Direction</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary" onclick="resetDirectionLimits({{ radar.id }})">
                                                <i class="fas fa-undo"></i> Reset
                                            </button>
                                        </div>
                                    </div>
                                    <div class="range-controls mb-2">
                                        <div class="d-flex justify-content-between mb-1">
                                            <small class="text-muted">Min: <span class="direction-min-value">0</span></small>
                                            <small class="text-muted">Max: <span class="direction-max-value">1000</span></small>
                                        </div>
                                        <div class="range-sliders">
                                            <input type="range" class="form-range direction-min" 
                                                   min="0" max="2000" value="0" step="10"
                                                   oninput="updateDirectionLimits({{ radar.id }})">
                                            <input type="range" class="form-range direction-max" 
                                                   min="0" max="2000" value="1000" step="10"
                                                   oninput="updateDirectionLimits({{ radar.id }})">
                                        </div>
                                    </div>
                                    <div style="width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 4px;">
                                        <canvas id="directionChart_{{ radar.id }}" style="width: 100%; height: 100%;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Raw Serial Data Display -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 d-flex align-items-center">
                                <i class="fas fa-terminal me-2"></i>Raw Serial Data
                                <button class="btn btn-sm btn-outline-secondary ms-2" type="button" 
                                        onclick="toggleSerialDataCollapse({{ radar.id }})">
                                    <i class="fas fa-chevron-down" id="collapseIcon_{{ radar.id }}"></i>
                                </button>
                            </h6>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="clearSerialData({{ radar.id }})">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                                <button class="btn btn-outline-secondary" onclick="toggleAutoScroll({{ radar.id }})">
                                    <i class="fas fa-scroll"></i> Auto-scroll
                                </button>
                            </div>
                        </div>
                        <div id="serialDataCollapse_{{ radar.id }}" class="card-body p-0">
                            <div id="serialData_{{ radar.id }}" class="serial-terminal">
                                <div class="serial-content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Radar Data Files Table -->
                    <div class="table-responsive">
                        <table id="radarDataTable_{{ radar.id }}" class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Filename</th>
                                    <th>Saved At</th>
                                    <th>Records</th>
                                    <th>File Size</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data_file in radar.data_files.all %}
                                <tr>
                                    <td></td>
                                    <td>{{ data_file.filename }}</td>
                                    <td>{{ data_file.timestamp|date:"Y-m-d H:i:s" }}</td>
                                    <td>{{ data_file.record_count }}</td>
                                    <td>{{ data_file.file_size|filesizeformat }}</td>
                                    <td>
                                        {% if data_file.is_valid %}
                                        <span class="badge bg-success">Valid</span>
                                        {% else %}
                                        <span class="badge bg-danger">Invalid</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'download_radar_file' data_file.id %}" class="btn btn-primary" title="Download">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger" 
                                                    onclick="deleteRadarFile({{ data_file.id }}, '{{ data_file.filename }}')"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No data files saved yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Load jQuery first -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- Load DataTables and its dependencies -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css">
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>

<!-- Load Chart.js and its date adapter -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
    // Initialize radar charts
    const radarCharts = {};
    const radarData = {};
    const MAX_DATA_POINTS = 30; // Show last 30 seconds of data
    const UPDATE_INTERVAL = 100; // Update every 0.1 seconds

    // Add time range configuration with persistence
    const timeRanges = {};
    const timeRangeUnits = {};
    
    // Function to get stored time range or default to 5 seconds
    function getStoredTimeRange(radarId) {
        const storedRange = localStorage.getItem(`timeRange_${radarId}`);
        const storedUnit = localStorage.getItem(`timeRangeUnit_${radarId}`);
        return {
            range: storedRange ? parseFloat(storedRange) : 0.083, // 5 seconds default
            unit: storedUnit || 'seconds'
        };
    }
    
    // Function to set time range
    function setTimeRange(radarId, minutes) {
        timeRanges[radarId] = minutes;
        timeRangeUnits[radarId] = 'minutes';
        localStorage.setItem(`timeRange_${radarId}`, minutes);
        localStorage.setItem(`timeRangeUnit_${radarId}`, 'minutes');
        document.getElementById(`customTimeRange_${radarId}`).value = minutes;
        updateChartTimeRanges(radarId);
    }
    
    // Function to set custom time range
    function setCustomTimeRange(radarId, value) {
        const unit = timeRangeUnits[radarId] || 'minutes';
        let minutes = parseFloat(value) || 5;
        
        if (unit === 'seconds') {
            minutes = minutes / 60;
        }
        
        minutes = Math.max(0.083, Math.min(60, minutes)); // 0.083 minutes = 5 seconds
        setTimeRange(radarId, minutes);
    }
    
    // Function to update time range unit
    function updateTimeRangeUnit(radarId, unit) {
        timeRangeUnits[radarId] = unit;
        localStorage.setItem(`timeRangeUnit_${radarId}`, unit);
        const input = document.getElementById(`customTimeRange_${radarId}`);
        let value = parseFloat(input.value) || 5;
        
        if (unit === 'seconds') {
            value = value * 60;
            input.min = 5;
            input.max = 3600;
            input.step = 5;
        } else {
            value = value / 60;
            input.min = 0.083;
            input.max = 60;
            input.step = 0.083;
        }
        
        input.value = value;
        setCustomTimeRange(radarId, value);
    }

    // Function to get stored range limits
    function getStoredRangeLimits(radarId) {
        return {
            min: parseFloat(localStorage.getItem(`rangeMin_${radarId}`)) || -100,
            max: parseFloat(localStorage.getItem(`rangeMax_${radarId}`)) || 100
        };
    }

    // Function to get stored speed limits
    function getStoredSpeedLimits(radarId) {
        return {
            min: parseFloat(localStorage.getItem(`speedMin_${radarId}`)) || 0,
            max: parseFloat(localStorage.getItem(`speedMax_${radarId}`)) || 1000
        };
    }

    // Function to get stored direction limits
    function getStoredDirectionLimits(radarId) {
        return {
            min: parseFloat(localStorage.getItem(`directionMin_${radarId}`)) || 0,
            max: parseFloat(localStorage.getItem(`directionMax_${radarId}`)) || 1000
        };
    }

    // Function to update range limits
    function updateRangeLimits(radarId) {
        const minInput = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-min');
        const maxInput = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-max');
        const minValue = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-min-value');
        const maxValue = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-max-value');
        
        const min = parseFloat(minInput.value);
        const max = parseFloat(maxInput.value);
        
        // Store values
        localStorage.setItem(`rangeMin_${radarId}`, min);
        localStorage.setItem(`rangeMax_${radarId}`, max);
        
        // Update displayed values
        minValue.textContent = min;
        maxValue.textContent = max;
        
        if (min < max) {
            const chart = radarCharts[`range_${radarId}`];
            if (chart) {
                chart.options.scales.y.min = min;
                chart.options.scales.y.max = max;
                chart.update('none');
            }
        }
    }

    // Function to update speed limits
    function updateSpeedLimits(radarId) {
        const minInput = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-min');
        const maxInput = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-max');
        const minValue = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-min-value');
        const maxValue = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-max-value');
        
        const min = parseFloat(minInput.value);
        const max = parseFloat(maxInput.value);
        
        // Store values
        localStorage.setItem(`speedMin_${radarId}`, min);
        localStorage.setItem(`speedMax_${radarId}`, max);
        
        // Update displayed values
        minValue.textContent = min;
        maxValue.textContent = max;
        
        if (min < max) {
            const chart = radarCharts[`speed_${radarId}`];
            if (chart) {
                chart.options.scales.y.min = min;
                chart.options.scales.y.max = max;
                chart.update('none');
            }
        }
    }

    // Function to update direction limits
    function updateDirectionLimits(radarId) {
        const minInput = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-min');
        const maxInput = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-max');
        const minValue = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-min-value');
        const maxValue = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-max-value');
        
        const min = parseFloat(minInput.value);
        const max = parseFloat(maxInput.value);
        
        // Store values
        localStorage.setItem(`directionMin_${radarId}`, min);
        localStorage.setItem(`directionMax_${radarId}`, max);
        
        // Update displayed values
        minValue.textContent = min;
        maxValue.textContent = max;
        
        if (min < max) {
            const chart = radarCharts[`direction_${radarId}`];
            if (chart) {
                chart.options.scales.r.min = min;
                chart.options.scales.r.max = max;
                chart.update('none');
            }
        }
    }

    // Function to reset range limits
    function resetRangeLimits(radarId) {
        const minInput = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-min');
        const maxInput = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-max');
        minInput.value = -100;
        maxInput.value = 100;
        localStorage.removeItem(`rangeMin_${radarId}`);
        localStorage.removeItem(`rangeMax_${radarId}`);
        updateRangeLimits(radarId);
    }

    // Function to reset speed limits
    function resetSpeedLimits(radarId) {
        const minInput = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-min');
        const maxInput = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-max');
        minInput.value = 0;
        maxInput.value = 1000;
        localStorage.removeItem(`speedMin_${radarId}`);
        localStorage.removeItem(`speedMax_${radarId}`);
        updateSpeedLimits(radarId);
    }

    // Function to reset direction limits
    function resetDirectionLimits(radarId) {
        const minInput = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-min');
        const maxInput = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-max');
        minInput.value = 0;
        maxInput.value = 1000;
        localStorage.removeItem(`directionMin_${radarId}`);
        localStorage.removeItem(`directionMax_${radarId}`);
        updateDirectionLimits(radarId);
    }

    // Function to update chart time ranges
    function updateChartTimeRanges(radarId) {
        const minutes = timeRanges[radarId] || 5;
        const rangeChart = radarCharts[`range_${radarId}`];
        const speedChart = radarCharts[`speed_${radarId}`];
        
        if (rangeChart) {
            rangeChart.options.scales.x.min = new Date(Date.now() - minutes * 60 * 1000);
            rangeChart.options.scales.x.max = new Date();
            rangeChart.update('none');
        }
        
        if (speedChart) {
            speedChart.options.scales.x.min = new Date(Date.now() - minutes * 60 * 1000);
            speedChart.options.scales.x.max = new Date();
            speedChart.update('none');
        }
    }

    // Add debug function
    function debugLog(message, data) {
        console.log(`[Chart Debug] ${message}`, data || '');
    }

    function initRadarCharts() {
        debugLog('Initializing radar charts...');
        
        {% for radar in radars %}
        const radarId = {{ radar.id }};
        debugLog(`Setting up charts for radar ${radarId}`);
        
        // Set default time range
        timeRanges[radarId] = 5;
        
        // Common options for all charts
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'second',
                        displayFormats: {
                            second: 'HH:mm:ss'
                        },
                        tooltipFormat: 'HH:mm:ss'
                    },
                    grid: {
                        color: '#e0e0e0'
                    },
                    ticks: {
                        color: '#666666',
                        maxRotation: 0
                    },
                    min: new Date(Date.now() - 5 * 60 * 1000), // 5 minutes ago
                    max: new Date() // now
                },
                y: {
                    grid: {
                        color: '#e0e0e0'
                    },
                    ticks: {
                        color: '#666666'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}`;
                        }
                    }
                }
            }
        };

        // Range Chart
        const rangeCtx = document.getElementById(`rangeChart_${radarId}`).getContext('2d');
        const rangeChart = new Chart(rangeCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Range',
                    data: [],
                    borderColor: '#007bff',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    y: {
                        ...commonOptions.scales.y,
                        min: -100,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Range (m)',
                            color: '#666666'
                        }
                    }
                }
            }
        });

        // Speed Chart
        const speedCtx = document.getElementById(`speedChart_${radarId}`).getContext('2d');
        const speedChart = new Chart(speedCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Speed',
                    data: [],
                    borderColor: '#28a745',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: false,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    ...commonOptions.scales,
                    y: {
                        ...commonOptions.scales.y,
                        min: 0,
                        max: 1000,
                        title: {
                            display: true,
                            text: 'Speed (mm/s)',
                            color: '#666666'
                        }
                    }
                }
            }
        });

        // Direction Chart
        const directionCtx = document.getElementById(`directionChart_${radarId}`).getContext('2d');
        const directionChart = new Chart(directionCtx, {
            type: 'radar',
            data: {
                labels: ['0° (N)', '45° (NE)', '90° (E)', '135° (SE)', '180° (S)', '225° (SW)', '270° (W)', '315° (NW)'],
                datasets: [{
                    label: 'Direction',
                    data: [0, 0, 0, 0, 0, 0, 0, 0],
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.2)',
                    borderWidth: 2,
                    pointBackgroundColor: '#17a2b8',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: '#17a2b8'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                scales: {
                    r: {
                        angleLines: {
                            display: true,
                            color: '#e0e0e0',
                            lineWidth: 1
                        },
                        suggestedMin: 0,
                        suggestedMax: 1000,
                        ticks: {
                            stepSize: 200,
                            color: '#666666',
                            backdropColor: 'transparent',
                            z: 1
                        },
                        pointLabels: {
                            color: '#666666',
                            font: {
                                size: 12,
                                weight: 'bold'
                            },
                            padding: 20,
                            z: 2
                        },
                        grid: {
                            color: '#e0e0e0',
                            circular: true
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const angle = context.dataIndex * 45;
                                return [
                                    `Angle: ${angle}°`,
                                    `Speed: ${context.raw.toFixed(1)} mm/s`
                                ];
                            }
                        }
                    }
                }
            }
        });

        // Store chart references
        radarCharts[`range_${radarId}`] = rangeChart;
        radarCharts[`speed_${radarId}`] = speedChart;
        radarCharts[`direction_${radarId}`] = directionChart;

        // Initialize data storage
        radarData[radarId] = {
            range: [],
            speed: [],
            direction: []
        };

        // Initialize charts with multiple zero values
        const now = new Date();
        const initialDataPoints = [];
        
        // Create 10 initial data points spanning the last minute
        for (let i = 0; i < 10; i++) {
            const time = new Date(now.getTime() - (60 - i * 6) * 1000);
            initialDataPoints.push({
                x: time,
                y: 0
            });
        }

        // Add initial data points to all charts
        if (rangeChart) {
            try {
                debugLog('Updating range chart with initial data');
                rangeChart.data.datasets[0].data = initialDataPoints;
                rangeChart.update('none');
                debugLog('Range chart updated with initial data');
            } catch (error) {
                console.error('Error updating range chart:', error);
            }
        }

        if (speedChart) {
            try {
                debugLog('Updating speed chart with initial data');
                speedChart.data.datasets[0].data = initialDataPoints;
                speedChart.update('none');
                debugLog('Speed chart updated with initial data');
            } catch (error) {
                console.error('Error updating speed chart:', error);
            }
        }

        if (directionChart) {
            try {
                debugLog('Updating direction chart with initial data');
                directionChart.data.datasets[0].data = initialDataPoints;
                directionChart.update('none');
                debugLog('Direction chart updated with initial data');
            } catch (error) {
                console.error('Error updating direction chart:', error);
            }
        }
        {% endfor %}
    }

    // Initialize serial data display
    const serialDataCollapsed = {};

    function initSerialData() {
        {% for radar in radars %}
        const radarId = {{ radar.id }};
        const serialContent = document.querySelector(`#serialData_${radarId} .serial-content`);
        const autoScroll = localStorage.getItem(`autoScroll_${radarId}`) !== 'false';
        
        // Initialize collapse state - default to true (collapsed)
        serialDataCollapsed[radarId] = localStorage.getItem(`serialDataCollapsed_${radarId}`) !== 'false';
        
        // Set initial collapse state
        const collapseElement = document.getElementById(`serialDataCollapse_${radarId}`);
        const collapseIcon = document.getElementById(`collapseIcon_${radarId}`);
        if (collapseElement && collapseIcon) {
            if (serialDataCollapsed[radarId]) {
                collapseElement.classList.add('collapsed');
                collapseIcon.classList.remove('fa-chevron-down');
                collapseIcon.classList.add('fa-chevron-right');
            } else {
                collapseElement.classList.remove('collapsed');
                collapseIcon.classList.remove('fa-chevron-right');
                collapseIcon.classList.add('fa-chevron-down');
            }
        }
        
        // Store auto-scroll state
        window.autoScrollStates = window.autoScrollStates || {};
        window.autoScrollStates[radarId] = autoScroll;
        
        // Clear existing content
        if (serialContent) {
            serialContent.innerHTML = '';
        }
        {% endfor %}
    }

    // Function to update serial data display
    function updateSerialData(radarId, data) {
        const serialContent = document.querySelector(`#serialData_${radarId} .serial-content`);
        if (!serialContent) {
            console.error(`Serial content element not found for radar ${radarId}`);
            return;
        }

        // Create a new line for the data
        const line = document.createElement('div');
        line.className = 'serial-line';
        
        // Add timestamp
        const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'serial-timestamp';
        timestampSpan.textContent = `[${timestamp}] `;
        line.appendChild(timestampSpan);
        
        // Add the data text
        const textSpan = document.createElement('span');
        textSpan.className = 'serial-text';
        
        // Debug log the incoming data
        console.log(`Received data for radar ${radarId}:`, data);
        
        // Use display_text if available, otherwise fall back to raw_data or message
        const displayText = data.display_text || data.raw_data || data.message || 'No data available';
        textSpan.textContent = displayText;
        
        // Set color based on connection status using data attributes
        if (data.connection_status) {
            textSpan.setAttribute('data-status', data.connection_status);
        }
        
        line.appendChild(textSpan);
        
        // Prepend the new line at the top of the content
        serialContent.insertBefore(line, serialContent.firstChild);
        
        // Auto-scroll if enabled
        if (window.autoScrollStates[radarId]) {
            serialContent.scrollTop = 0;  // Scroll to top since new data is at the top
        }
    }

    // Function to clear serial data
    function clearSerialData(radarId) {
        const serialContent = document.querySelector(`#serialData_${radarId} .serial-content`);
        if (serialContent) {
            serialContent.innerHTML = '';
        }
    }

    // Function to toggle auto-scroll
    function toggleAutoScroll(radarId) {
        window.autoScrollStates[radarId] = !window.autoScrollStates[radarId];
        localStorage.setItem(`autoScroll_${radarId}`, window.autoScrollStates[radarId]);
        
        // Update button appearance
        const button = document.querySelector(`#serialData_${radarId}`).closest('.card').querySelector('.btn-outline-secondary:nth-child(2)');
        if (button) {
            if (window.autoScrollStates[radarId]) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        }
    }

    // Function to update radar data
    function updateRadarData() {
        {% for radar in radars %}
        const radarId = {{ radar.id }};
        const minutes = timeRanges[radarId] || 5;
        const maxDataPoints = Math.ceil(minutes * 60 * 1000 / UPDATE_INTERVAL);
        
        // Update time ranges for charts
        updateChartTimeRanges(radarId);
        
        // Original API call for real data
        fetch(`/api/radar-data/${radarId}/`)
            .then(response => {
                console.log(`Response status for radar ${radarId}:`, response.status);
                return response.json();
            })
            .then(data => {
                console.log(`Raw API response for radar ${radarId}:`, data);
                
                // Check if we have actual data or just a status message
                const hasData = data && data.status === 'success' && 
                              !data.message && 
                              (data.range !== undefined || data.speed !== undefined);
                
                // Check if we have a "No new data available" message
                const noDataMessage = data.message === 'No new data available';
                
                if (hasData) {
                    const timestamp = new Date(data.timestamp * 1000);
                    const range = parseFloat(data.range) || 0;
                    const speed = parseFloat(data.speed) || 0;
                    const angle = parseFloat(data.angle) || 0;
                    
                    console.log(`Processing data point:`, { timestamp, range, speed, angle });
                    
                    // Update range chart
                    const rangeChart = radarCharts[`range_${radarId}`];
                    if (rangeChart) {
                        const currentData = rangeChart.data.datasets[0].data;
                        currentData.push({
                            x: timestamp,
                            y: range
                        });
                        
                        if (currentData.length > maxDataPoints) {
                            currentData.shift();
                        }
                        
                        rangeChart.update('none');
                    }
                    
                    // Update speed chart
                    const speedChart = radarCharts[`speed_${radarId}`];
                    if (speedChart) {
                        const currentData = speedChart.data.datasets[0].data;
                        currentData.push({
                            x: timestamp,
                            y: speed
                        });
                        
                        if (currentData.length > maxDataPoints) {
                            currentData.shift();
                        }
                        
                        speedChart.update('none');
                    }

                    // Update direction chart
                    const directionChart = radarCharts[`direction_${radarId}`];
                    if (directionChart) {
                        // Convert angle to index (0-7 for 8 directions)
                        const angleIndex = Math.round((angle % 360) / 45) % 8;
                        
                        // Create new data array with zeros
                        const newData = new Array(8).fill(0);
                        // Set speed at the correct angle
                        newData[angleIndex] = speed;
                        
                        directionChart.data.datasets[0].data = newData;
                        directionChart.update('none');
                    }
                    
                    // Update status badge to show connected
                    const statusBadge = document.querySelector(`#radar_${radarId} .badge`);
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.textContent = 'Connected';
                    }
                    
                    // Update serial data display with the data
                    updateSerialData(radarId, {
                        ...data,
                        connection_status: 'connected',
                        display_text: `[CONNECTED] Range: ${range.toFixed(1)}m, Speed: ${speed.toFixed(1)}mm/s`
                    });
                } else {
                    // No data available - update status accordingly
                    const statusBadge = document.querySelector(`#radar_${radarId} .badge`);
                    if (statusBadge) {
                        if (data.connection_status === 'error') {
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = 'Error';
                        } else if (data.connection_status === 'disconnected') {
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = 'Disconnected';
                        } else if (data.connection_status === 'retrying') {
                            statusBadge.className = 'badge bg-warning';
                            statusBadge.textContent = 'Retrying...';
                        } else if (noDataMessage) {
                            // If we get "No new data available", treat it as disconnected
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = 'Disconnected';
                        } else {
                            statusBadge.className = 'badge bg-warning';
                            statusBadge.textContent = 'Waiting for data';
                        }
                    }
                    
                    // Update serial data display with status message
                    updateSerialData(radarId, {
                        timestamp: data.timestamp || Math.floor(Date.now() / 1000),
                        display_text: noDataMessage ? 'Connection lost - No data available' : (data.message || 'No data available'),
                        connection_status: noDataMessage ? 'disconnected' : (data.connection_status || 'disconnected')
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching radar data:', error);
                const statusBadge = document.querySelector(`#radar_${radarId} .badge`);
                if (statusBadge) {
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.textContent = 'Error';
                }

                // Add error message to serial display
                updateSerialData(radarId, {
                    timestamp: Math.floor(Date.now() / 1000),
                    display_text: 'Error fetching data',
                    connection_status: 'error'
                });
            });
        {% endfor %}
    }

    // Initialize charts when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing charts...');
        initRadarCharts();
        initSerialData();
        
        // Load stored settings for each radar
        {% for radar in radars %}
        const radarId = {{ radar.id }};
        
        // Load time range settings
        const timeRangeSettings = getStoredTimeRange(radarId);
        setTimeRange(radarId, timeRangeSettings.range);
        updateTimeRangeUnit(radarId, timeRangeSettings.unit);
        
        // Load range limits
        const rangeLimits = getStoredRangeLimits(radarId);
        const rangeMinInput = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-min');
        const rangeMaxInput = document.querySelector(`#rangeChart_${radarId}`).closest('.card-body').querySelector('.range-max');
        rangeMinInput.value = rangeLimits.min;
        rangeMaxInput.value = rangeLimits.max;
        updateRangeLimits(radarId);
        
        // Load speed limits
        const speedLimits = getStoredSpeedLimits(radarId);
        const speedMinInput = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-min');
        const speedMaxInput = document.querySelector(`#speedChart_${radarId}`).closest('.card-body').querySelector('.speed-max');
        speedMinInput.value = speedLimits.min;
        speedMaxInput.value = speedLimits.max;
        updateSpeedLimits(radarId);
        
        // Load direction limits
        const directionLimits = getStoredDirectionLimits(radarId);
        const directionMinInput = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-min');
        const directionMaxInput = document.querySelector(`#directionChart_${radarId}`).closest('.card-body').querySelector('.direction-max');
        directionMinInput.value = directionLimits.min;
        directionMaxInput.value = directionLimits.max;
        updateDirectionLimits(radarId);
        {% endfor %}
        
        // Update data immediately and then every 100ms
        updateRadarData();
        setInterval(updateRadarData, UPDATE_INTERVAL);
    });

    // Function to delete radar file
    function deleteRadarFile(fileId, filename) {
        if (confirm(`Are you sure you want to delete "${filename}"?`)) {
            fetch(`/api/radar-file/${fileId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Reload the page to show updated file list
                    window.location.reload();
                } else {
                    alert('Error deleting file: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting file. Please try again.');
            });
        }
    }

    // Function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function toggleSerialDataCollapse(radarId) {
        const collapseElement = document.getElementById(`serialDataCollapse_${radarId}`);
        const collapseIcon = document.getElementById(`collapseIcon_${radarId}`);
        
        if (collapseElement && collapseIcon) {
            serialDataCollapsed[radarId] = !serialDataCollapsed[radarId];
            localStorage.setItem(`serialDataCollapsed_${radarId}`, serialDataCollapsed[radarId]);
            
            if (serialDataCollapsed[radarId]) {
                collapseElement.classList.add('collapsed');
                collapseIcon.classList.remove('fa-chevron-down');
                collapseIcon.classList.add('fa-chevron-right');
            } else {
                collapseElement.classList.remove('collapsed');
                collapseIcon.classList.remove('fa-chevron-right');
                collapseIcon.classList.add('fa-chevron-down');
            }
        }
    }

    // Add styles for serial data display
    const style = document.createElement('style');
    style.textContent = `
        .serial-line {
            margin-bottom: 2px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #ffffff;  /* Ensure text is visible */
        }
        
        .serial-timestamp {
            color: #888;
            margin-right: 8px;
            font-weight: bold;  /* Make timestamp more visible */
        }
        
        .serial-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #ffffff;  /* Ensure text is visible */
        }
        
        .serial-terminal {
            background-color: #1e1e1e;
            color: #ffffff;  /* Default text color */
            font-family: 'Consolas', 'Monaco', monospace;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            border-radius: 0 0 0.25rem 0.25rem;
            font-size: 0.9rem;
            line-height: 1.4;
            border: 1px solid #333;  /* Add border for better visibility */
        }
        
        .serial-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #ffffff;  /* Ensure text is visible */
        }
        
        .serial-terminal::-webkit-scrollbar {
            width: 8px;
        }
        
        .serial-terminal::-webkit-scrollbar-track {
            background: #2d2d2d;
        }
        
        .serial-terminal::-webkit-scrollbar-thumb {
            background: #666;
            border-radius: 4px;
        }
        
        .serial-terminal::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        
        .btn-outline-secondary.active {
            background-color: #6c757d;
            color: white;
        }

        /* Add styles for collapsed state */
        .collapsed {
            display: none !important;
        }

        /* Add styles for connection status colors */
        .serial-text[data-status="connected"] {
            color: #00ff00 !important;  /* Green for connected */
        }
        
        .serial-text[data-status="disconnected"] {
            color: #ff0000 !important;  /* Red for disconnected */
        }
        
        .serial-text[data-status="error"] {
            color: #ff9900 !important;  /* Orange for error */
        }
        
        .serial-text[data-status="retrying"] {
            color: #ffff00 !important;  /* Yellow for retrying */
        }
        
        .serial-text[data-status="connecting"] {
            color: #00ffff !important;  /* Cyan for connecting */
        }
    `;
    document.head.appendChild(style);

    $(document).ready(function() {
        // Initialize DataTables for each radar
        {% for radar in radars %}
        (function() {
            const radarId = {{ radar.id }};
            const table = $('#radarDataTable_' + radarId).DataTable({
                "pageLength": 5,
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                "order": [[2, 'desc']], // Sort by Saved At column by default
                "columnDefs": [
                    { 
                        "orderable": false, 
                        "targets": [0, 6],
                        "className": "text-center"
                    },
                    { "className": "text-center", "targets": [3, 4, 5] },
                    { "width": "5%", "targets": 0 },
                    { "width": "15%", "targets": 6 }
                ],
                "language": {
                    "search": "Search files:",
                    "lengthMenu": "Show _MENU_ files per page",
                    "info": "Showing _START_ to _END_ of _TOTAL_ files",
                    "infoEmpty": "No files available",
                    "infoFiltered": "(filtered from _MAX_ total files)",
                    "paginate": {
                        "first": "«",
                        "last": "»",
                        "next": "›",
                        "previous": "‹"
                    }
                },
                "pagingType": "full_numbers",
                "drawCallback": function(settings) {
                    // Get the current page and page length
                    const api = this.api();
                    const pageInfo = api.page.info();
                    const startIndex = pageInfo.start;
                    
                    // Update row numbers
                    api.column(0, {search:'applied', order:'applied'}).nodes().each(function(cell, i) {
                        cell.innerHTML = startIndex + i + 1;
                    });
                },
                "dom": "<'row'<'col-sm-12 col-md-6'l><'col-sm-12 col-md-6'f>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                "responsive": true,
                "processing": true,
                "serverSide": false,
                "ajax": {
                    "url": `/api/radar-files/${radarId}/`,
                    "dataSrc": "data"
                },
                "columns": [
                    { 
                        "data": null,
                        "defaultContent": "" // Empty content, will be filled by drawCallback
                    },
                    { "data": "filename" },
                    { "data": "timestamp" },
                    { "data": "record_count" },
                    { 
                        "data": "file_size",
                        "render": function(data) {
                            return formatFileSize(data);
                        }
                    },
                    { 
                        "data": "is_valid",
                        "render": function(data) {
                            return data ? 
                                '<span class="badge bg-success">Valid</span>' : 
                                '<span class="badge bg-danger">Invalid</span>';
                        }
                    },
                    {
                        "data": "id",
                        "render": function(data, type, row) {
                            return `
                                <div class="btn-group btn-group-sm">
                                    <a href="/radar-file/${data}/download/" class="btn btn-primary" title="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button type="button" class="btn btn-danger" 
                                            onclick="deleteRadarFile(${data}, '${row.filename}')"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });

            // Store the table reference in a global object
            window.radarTables = window.radarTables || {};
            window.radarTables[radarId] = table;
        })();
        {% endfor %}

        // Function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Function to refresh all radar data tables
        function refreshRadarTables() {
            if (window.radarTables) {
                Object.values(window.radarTables).forEach(table => {
                    table.ajax.reload(null, false);
                });
            }
        }

        // Refresh the tables every 30 seconds
        setInterval(refreshRadarTables, 30000);
    });
</script>

<style>
.serial-terminal {
    background-color: #1e1e1e;
    color: #00ff00;
    font-family: 'Consolas', 'Monaco', monospace;
    height: 200px;
    overflow-y: auto;
    padding: 10px;
    border-radius: 0 0 0.25rem 0.25rem;
    font-size: 0.9rem;
    line-height: 1.4;
}

.serial-content {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-family: 'Consolas', 'Monaco', monospace;
}

/* Style for the timestamp */
.serial-content {
    color: #00ff00;
}

/* Style for the raw data */
.serial-content {
    color: #00ff00;
}

/* Add a subtle separator between lines */
.serial-content {
    border-bottom: 1px solid rgba(0, 255, 0, 0.1);
    padding-bottom: 2px;
    margin-bottom: 2px;
}

.serial-terminal::-webkit-scrollbar {
    width: 8px;
}

.serial-terminal::-webkit-scrollbar-track {
    background: #2d2d2d;
}

.serial-terminal::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 4px;
}

.serial-terminal::-webkit-scrollbar-thumb:hover {
    background: #888;
}

.collapsed {
    display: none !important;
}

/* Add styles for the collapse button */
.btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    color: white;
}

.btn-outline-secondary i {
    font-size: 0.875rem;
    width: 1rem;
    text-align: center;
}

/* Range slider styles */
.range-controls {
    padding: 0 10px;
}

.range-sliders {
    position: relative;
    height: 40px;
}

.form-range {
    position: absolute;
    width: 100%;
    pointer-events: none;
    -webkit-appearance: none;
    appearance: none;
    height: 2px;
    background: #dee2e6;
    outline: none;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.form-range:hover {
    opacity: 1;
}

.form-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    pointer-events: auto;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.form-range::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #007bff;
    cursor: pointer;
    pointer-events: auto;
    border: 2px solid #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.range-min {
    top: 0;
}

.range-max {
    top: 20px;
}

/* Active state for range thumbs */
.form-range:active::-webkit-slider-thumb {
    background: #0056b3;
    transform: scale(1.1);
}

.form-range:active::-moz-range-thumb {
    background: #0056b3;
    transform: scale(1.1);
}
</style>
{% endblock %} 