{% extends 'base.html' %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">System Dashboard</h2>
    </div>
</div>

<!-- System Info Cards -->
<div class="row mb-4">
    <!-- CPU Temperature Card -->
    <div class="col-md-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-thermometer-half me-2"></i>CPU Temperature
                </h5>
                <div class="text-center">
                    <h2 class="display-6 cpu-temp">{{ system_info.cpu_temp }}°C</h2>
                    <p class="text-muted cpu-avg mb-0">24h Avg: {{ system_info.history.cpu_avg }}°C</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Disk Usage Card -->
    <div class="col-md-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-hdd me-2"></i>Disk Usage
                </h5>
                <div class="progress mb-2">
                    <div class="progress-bar disk-progress" role="progressbar" 
                         style="width: {{ system_info.disk.percent }}%" 
                         aria-valuenow="{{ system_info.disk.percent }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ system_info.disk.percent }}%
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col">
                        <small class="text-muted">Total</small>
                        <p class="mb-0 disk-total">{{ system_info.disk.total }} GB</p>
                    </div>
                    <div class="col">
                        <small class="text-muted">Used</small>
                        <p class="mb-0 disk-used">{{ system_info.disk.used }} GB</p>
                    </div>
                    <div class="col">
                        <small class="text-muted">Free</small>
                        <p class="mb-0 disk-free">{{ system_info.disk.free }} GB</p>
                    </div>
                </div>
                <p class="text-muted disk-avg text-center mb-0">24h Avg: {{ system_info.history.disk_avg }}%</p>
            </div>
        </div>
    </div>

    <!-- RAM Usage Card -->
    <div class="col-md-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-memory me-2"></i>RAM Usage
                </h5>
                <div class="progress mb-2">
                    <div class="progress-bar ram-progress" role="progressbar" 
                         style="width: {{ system_info.ram.percent }}%" 
                         aria-valuenow="{{ system_info.ram.percent }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                        {{ system_info.ram.percent }}%
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col">
                        <small class="text-muted">Total</small>
                        <p class="mb-0 ram-total">{{ system_info.ram.total }} GB</p>
                    </div>
                    <div class="col">
                        <small class="text-muted">Used</small>
                        <p class="mb-0 ram-used">{{ system_info.ram.used }} GB</p>
                    </div>
                    <div class="col">
                        <small class="text-muted">Free</small>
                        <p class="mb-0 ram-free">{{ system_info.ram.free }} GB</p>
                    </div>
                </div>
                <p class="text-muted ram-avg text-center mb-0">24h Avg: {{ system_info.history.ram_avg }}%</p>
            </div>
        </div>
    </div>

    <!-- System Uptime Card -->
    <div class="col-md-3 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-clock me-2"></i>System Uptime
                </h5>
                <div class="text-center">
                    <h2 class="display-6 uptime">{{ system_info.uptime }}</h2>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Radar Dashboard -->
<div class="row">
    <div class="col-12">
        <h3 class="mb-4">Radar Data</h3>
    </div>
</div>

<div class="row">
    <!-- Radar Data Cards -->
    <div class="col-12">
        <div class="row" id="radar-cards">
            {% for radar in radars %}
            <div class="col-md-4 mb-4">
                <div class="card h-100" id="radar-card-{{ radar.id }}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ radar.name }}</h5>
                        <div>
                            <span class="badge {% if radar.is_active %}bg-success{% else %}bg-danger{% endif %} me-2">
                                {% if radar.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                            <span class="badge bg-secondary" id="connection-status-{{ radar.id }}">Checking...</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="radar-data">
                            <div class="row">
                                <div class="col-6">
                                    <p class="mb-1"><strong>Port:</strong></p>
                                    <p class="mb-1"><strong>Baud Rate:</strong></p>
                                    <p class="mb-1"><strong>Update Interval:</strong></p>
                                    <p class="mb-1"><strong>Last Update:</strong></p>
                                </div>
                                <div class="col-6">
                                    <p class="mb-1">{{ radar.port }}</p>
                                    <p class="mb-1">{{ radar.baud_rate }}</p>
                                    <p class="mb-1">{{ radar.update_interval }}ms</p>
                                    <p class="mb-1" id="last-update-{{ radar.id }}">-</p>
                                </div>
                            </div>
                            <hr>
                            <div class="radar-live-data">
                                <h6 class="text-center mb-3">Live Data</h6>
                                <div id="radar-data-{{ radar.id }}" class="text-center">
                                    <p class="mb-1">Waiting for data...</p>
                                </div>
                                <div class="radar-graph mt-3">
                                    <canvas id="radar-graph-{{ radar.id }}" width="100%" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No radar configurations found. Please add a radar in the configuration page.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Store radar graphs
    const radarGraphs = {};
    const maxDataPoints = 50; // Maximum number of data points to show in graph

    // Function to initialize radar graph
    function initRadarGraph(radarId) {
        const ctx = document.getElementById(`radar-graph-${radarId}`).getContext('2d');
        radarGraphs[radarId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Range',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Range (m)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    }
                },
                animation: {
                    duration: 0
                }
            }
        });
    }

    // Function to update radar data
    function updateRadarData() {
        {% for radar in radars %}
        if (document.getElementById('radar-card-{{ radar.id }}')) {
            fetch(`/api/radar-data/{{ radar.id }}/`)
                .then(response => response.json())
                .then(data => {
                    const dataElement = document.getElementById('radar-data-{{ radar.id }}');
                    const lastUpdateElement = document.getElementById('last-update-{{ radar.id }}');
                    const connectionStatusElement = document.getElementById('connection-status-{{ radar.id }}');
                    
                    // Update connection status
                    let statusClass = 'bg-secondary';
                    let statusText = 'Unknown';
                    
                    switch(data.connection_status) {
                        case 'connected':
                            statusClass = 'bg-success';
                            statusText = 'Connected';
                            break;
                        case 'disconnected':
                            statusClass = 'bg-danger';
                            statusText = 'Disconnected';
                            break;
                        case 'inactive':
                            statusClass = 'bg-warning';
                            statusText = 'Inactive';
                            break;
                        case 'error':
                            statusClass = 'bg-danger';
                            statusText = 'Error';
                            break;
                    }
                    
                    connectionStatusElement.className = `badge ${statusClass}`;
                    connectionStatusElement.textContent = statusText;
                    
                    if (data.status === 'success') {
                        if (data.raw_data) {
                            dataElement.innerHTML = `<p class="mb-1">${data.raw_data}</p>`;
                        } else {
                            dataElement.innerHTML = `
                                <p class="mb-1"><strong>Range:</strong> ${data.range || 'N/A'} m</p>
                                <p class="mb-1"><strong>Speed:</strong> ${data.speed || 'N/A'} m/s</p>
                                <p class="mb-1"><strong>Direction:</strong> ${data.direction || 'N/A'}°</p>
                            `;

                            // Update graph if we have range data
                            if (data.range && radarGraphs[{{ radar.id }}]) {
                                const graph = radarGraphs[{{ radar.id }}];
                                const now = new Date().toLocaleTimeString();
                                
                                // Add new data point
                                graph.data.labels.push(now);
                                graph.data.datasets[0].data.push(data.range);
                                
                                // Remove old data points if we exceed maxDataPoints
                                if (graph.data.labels.length > maxDataPoints) {
                                    graph.data.labels.shift();
                                    graph.data.datasets[0].data.shift();
                                }
                                
                                graph.update();
                            }
                        }
                        lastUpdateElement.textContent = new Date().toLocaleTimeString();
                    } else {
                        dataElement.innerHTML = `<p class="text-danger">${data.message}</p>`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching radar data:', error);
                    document.getElementById('radar-data-{{ radar.id }}').innerHTML = 
                        '<p class="text-danger">Error fetching data</p>';
                });
        }
        {% endfor %}
    }

    // Function to start updates for a specific radar
    function startRadarUpdates(radarId, interval) {
        // Initialize graph
        initRadarGraph(radarId);
        
        // Initial update
        updateRadarData();
        
        // Set up periodic updates
        return setInterval(updateRadarData, interval);
    }

    // Start updates when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        {% for radar in radars %}
        if (document.getElementById('radar-card-{{ radar.id }}')) {
            startRadarUpdates({{ radar.id }}, {{ radar.update_interval }});
        }
        {% endfor %}
    });

    // Update system info every 30 minutes (1800000 ms)
    function updateSystemInfo() {
        fetch('{% url "system_info_api" %}')
            .then(response => response.json())
            .then(data => {
                // Disk
                document.querySelector('.disk-progress').style.width = data.disk.percent + '%';
                document.querySelector('.disk-progress').innerText = data.disk.percent + '%';
                document.querySelector('.disk-total').innerText = data.disk.total + ' GB';
                document.querySelector('.disk-used').innerText = data.disk.used + ' GB';
                document.querySelector('.disk-free').innerText = data.disk.free + ' GB';
                if (data.history.disk_avg !== null) {
                    document.querySelector('.disk-avg').innerText = '24h Avg: ' + data.history.disk_avg + '%';
                }
                // RAM
                document.querySelector('.ram-progress').style.width = data.ram.percent + '%';
                document.querySelector('.ram-progress').innerText = data.ram.percent + '%';
                document.querySelector('.ram-total').innerText = data.ram.total + ' GB';
                document.querySelector('.ram-used').innerText = data.ram.used + ' GB';
                document.querySelector('.ram-free').innerText = data.ram.free + ' GB';
                if (data.history.ram_avg !== null) {
                    document.querySelector('.ram-avg').innerText = '24h Avg: ' + data.history.ram_avg + '%';
                }
                // CPU Temp
                document.querySelector('.cpu-temp').innerText = data.cpu_temp + '°C';
                if (data.history.cpu_avg !== null) {
                    document.querySelector('.cpu-avg').innerText = '24h Avg: ' + data.history.cpu_avg + '°C';
                }
                // Uptime
                document.querySelector('.uptime').innerText = data.uptime;
            });
    }

    // Initial system info update
    updateSystemInfo();
    // Set up periodic system info updates
    setInterval(updateSystemInfo, 1800000); // Update every 30 minutes
</script>
{% endblock %} 