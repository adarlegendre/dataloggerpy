# CP5200 LED Display Library Test Makefile
# This Makefile is specifically for building and running test files

CC = gcc
CXX = g++
CFLAGS = -Wall -Wextra -std=c99
CXXFLAGS = -Wall -Wextra -std=c++11
LDFLAGS = -lcp5200 -lpthread

# Directories
SRC_DIR = .
BUILD_DIR = build
DIST_DIR = dist

# Source files
C_TEST_SRC = cp5200_test.c
CXX_TEST_SRC = 
PYTHON_TEST_SRC = cp5200_test.py

# Target executables
C_TEST_TARGET = cp5200_test
CXX_TEST_TARGET = 

# Python executable
PYTHON = python3

# Default target
all: build-tests

# Create build directory
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Build C test
$(BUILD_DIR)/$(C_TEST_TARGET): $(C_TEST_SRC) | $(BUILD_DIR)
	$(CC) $(CFLAGS) -o $@ $< $(LDFLAGS)
	@echo "Built C test: $@"

# Build C++ test (if needed)
$(BUILD_DIR)/$(CXX_TEST_TARGET): $(CXX_TEST_SRC) | $(BUILD_DIR)
	$(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS)
	@echo "Built C++ test: $@"

# Build all tests
build-tests: $(BUILD_DIR)/$(C_TEST_TARGET)
	@echo "All tests built successfully"

# Run C test
test-c: $(BUILD_DIR)/$(C_TEST_TARGET)
	@echo "Running C test..."
	./$(BUILD_DIR)/$(C_TEST_TARGET)

# Run Python test
test-python: $(PYTHON_TEST_SRC)
	@echo "Running Python test..."
	$(PYTHON) $(PYTHON_TEST_SRC)

# Run all tests
test: test-c test-python
	@echo "All tests completed"

# Run tests with custom IP
test-custom: $(BUILD_DIR)/$(C_TEST_TARGET) $(PYTHON_TEST_SRC)
	@echo "Running tests with custom configuration..."
	@read -p "Enter CP5200 IP address: " ip; \
	read -p "Enter port (default 5200): " port; \
	port=$${port:-5200}; \
	echo "Running C test with IP: $$ip, Port: $$port"; \
	CP5200_IP=$$ip CP5200_PORT=$$port ./$(BUILD_DIR)/$(C_TEST_TARGET); \
	echo "Running Python test with IP: $$ip, Port: $$port"; \
	$(PYTHON) $(PYTHON_TEST_SRC) --ip $$ip --port $$port

# Clean build files
clean:
	rm -rf $(BUILD_DIR)
	rm -f *.o *.a
	@echo "Cleaned build files"

# Install dependencies (Ubuntu/Debian)
install-deps:
	@echo "Installing dependencies..."
	sudo apt-get update
	sudo apt-get install -y build-essential g++ make libiconv-hook-dev pkg-config python3 python3-pip
	@echo "Dependencies installed"

# Install dependencies (Raspberry Pi)
install-deps-rpi: install-deps
	@echo "Installing Raspberry Pi specific dependencies..."
	sudo apt-get install -y python3-gpiozero python3-serial
	@echo "Raspberry Pi dependencies installed"

# Check if library is installed
check-lib:
	@echo "Checking CP5200 library installation..."
	@if [ -f "/usr/local/include/cp5200.h" ]; then \
		echo "✓ Header file found"; \
	else \
		echo "✗ Header file not found"; \
		exit 1; \
	fi
	@if [ -f "/usr/local/lib/libcp5200.a" ]; then \
		echo "✓ Library file found"; \
	else \
		echo "✗ Library file not found"; \
		exit 1; \
	fi
	@echo "CP5200 library is properly installed"

# Test compilation without running
test-compile: $(BUILD_DIR)/$(C_TEST_TARGET)
	@echo "✓ Compilation test passed"

# Quick test (minimal)
quick-test: test-compile
	@echo "Running quick test..."
	@timeout 10s ./$(BUILD_DIR)/$(C_TEST_TARGET) || echo "Test completed or timed out"

# Performance test
perf-test: $(BUILD_DIR)/$(C_TEST_TARGET)
	@echo "Running performance test..."
	@time ./$(BUILD_DIR)/$(C_TEST_TARGET)

# Network connectivity test
test-network:
	@echo "Testing network connectivity..."
	@read -p "Enter CP5200 IP address: " ip; \
	read -p "Enter port (default 5200): " port; \
	port=$${port:-5200}; \
	echo "Testing connection to $$ip:$$port"; \
	timeout 5s nc -zv $$ip $$port && echo "✓ Network connection successful" || echo "✗ Network connection failed"

# Serial port test
test-serial:
	@echo "Testing serial port..."
	@if [ -e "/dev/ttyAMA0" ]; then \
		echo "✓ Serial port /dev/ttyAMA0 exists"; \
	else \
		echo "✗ Serial port /dev/ttyAMA0 not found"; \
	fi
	@if [ -e "/dev/ttyUSB0" ]; then \
		echo "✓ Serial port /dev/ttyUSB0 exists"; \
	else \
		echo "✗ Serial port /dev/ttyUSB0 not found"; \
	fi

# System information
sys-info:
	@echo "System Information:"
	@echo "OS: $(shell uname -s)"
	@echo "Architecture: $(shell uname -m)"
	@echo "Kernel: $(shell uname -r)"
	@echo "GCC version: $(shell gcc --version | head -n1)"
	@echo "Python version: $(shell python3 --version)"
	@echo "Make version: $(shell make --version | head -n1)"

# Help
help:
	@echo "CP5200 LED Display Library Test Makefile"
	@echo "========================================"
	@echo ""
	@echo "Available targets:"
	@echo "  all              - Build all test files"
	@echo "  build-tests      - Build test executables"
	@echo "  test-c           - Run C test"
	@echo "  test-python      - Run Python test"
	@echo "  test             - Run all tests"
	@echo "  test-custom      - Run tests with custom IP/port"
	@echo "  test-compile     - Test compilation only"
	@echo "  quick-test       - Run minimal test"
	@echo "  perf-test        - Run performance test"
	@echo "  test-network     - Test network connectivity"
	@echo "  test-serial      - Test serial port availability"
	@echo "  check-lib        - Check library installation"
	@echo "  install-deps     - Install dependencies (Ubuntu/Debian)"
	@echo "  install-deps-rpi - Install dependencies (Raspberry Pi)"
	@echo "  sys-info         - Show system information"
	@echo "  clean            - Clean build files"
	@echo "  help             - Show this help"
	@echo ""
	@echo "Usage examples:"
	@echo "  make test-custom    # Run with custom IP/port"
	@echo "  make test-network   # Test network connectivity"
	@echo "  make install-deps   # Install dependencies"

# Phony targets
.PHONY: all build-tests test-c test-python test test-custom clean install-deps install-deps-rpi check-lib test-compile quick-test perf-test test-network test-serial sys-info help
